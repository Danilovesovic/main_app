<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/bootstrap.css">
    <link rel="stylesheet" href="/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/admin/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="./superadmin.css">

</head>
<body>
<%- include('../partials/navbar.ejs', { user: loggedUser})%>
<div class="container-fluid mt-5">
    <div class="row">
        <%- include('../partials/sidebar.ejs')%>
        <div class="col-10">
            <div class="d-flex align-items-center mb-3">
                <h2 class="text-uppercase">
                    <%= loggedUser.role%>
                </h2>
                <a href="/admin/superadmin/create" class="btn btn-outline-primary ms-auto">New User</a>
            </div>
            <hr>
            <div class="row">
                <div class="col-10 offset-1">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <% if (loggedUser.role==='superadmin' ) { %>
                                <th>Create task</th>
                                <% } %>
                            <th>Flag <span class="ms-1 text-primary"
                                    style="cursor: pointer; text-transform: uppercase; font-size: 0.85em; vertical-align: super;"
                                    data-bs-toggle="tooltip" title="Klikni na zastavicu za izbor boje flaga">
                                    <i class="bi bi-info-circle-fill"></i>
                                </span></th>
                            <% if (loggedUser.role==='superadmin' && loggedUser.main===true) { %>
                            <th>Delete</th>
                            <% } %>
                        </tr>
                        </thead>
                        <tbody>
                        <% users.forEach(function(user){ %>
                            <tr>
                                <td><%= user.username%></td>
                                <td class="role-expand <%= loggedUser.main == true ? 'clickable role-dropdown-menu text-primary' : ' text-dark' %>"
                                    data-user-id="<%= user._id %>"
                                    data-role="<%= user.role %>">
                                    <%= user.role || '' %>
                                        <%= user.main ? '*' : '' %>
                                </td>
                                <% if (loggedUser.role==='superadmin' ) { %>
                                    <td>
                                        <input type="checkbox" class="permission-toggle" data-user-id="<%= user._id %>" <%=user.permissions?.createTask
                                            ? 'checked' : '' %>
                                        >
                                
                                    </td>
                                    <% } %>
                                            <td>
                                                <% if (user.flag) { %>
                                                    <div class="dropdown">
                                                        <!-- klikabilna zastavica -->
                                                        <a href="#" id="flagDropdown<%= user._id %>" data-bs-toggle="dropdown" aria-expanded="false">
                                                            <% if (user.flag==='green' ) { %>
                                                                <i class="fa-regular fa-flag text-success fs-4"></i>
                                                                <% } else if (user.flag==='orange' ) { %>
                                                                    <i class="fa-regular fa-flag text-warning fs-4"></i>
                                                                    <% } else if (user.flag==='red' ) { %>
                                                                        <i class="fa-solid fa-flag text-danger fs-4"></i>
                                                                        <% } %>
                                                        </a>

                                        <!-- dropdown sa opcijama -->
                                        <ul class="dropdown-menu" aria-labelledby="flagDropdown<%= user._id %>">
                                            <li><a class="dropdown-item change-flag" href="#" data-user-id="<%= user._id %>" data-flag="green">游릭
                                                    Green</a></li>
                                            <li><a class="dropdown-item change-flag" href="#" data-user-id="<%= user._id %>" data-flag="orange">游
                                                    Orange</a></li>
                                            <li><a class="dropdown-item change-flag" href="#" data-user-id="<%= user._id %>" data-flag="red">游댮 Red</a>
                                            </li>
                                        </ul>
                                        </div>
                                        <% } else { %>
                                            <%= '' %>
                                                <% } %>
                                                    </td>
                                                    <% if (loggedUser.role==='superadmin' && loggedUser.main===true) { %>
                                                        <td>
                                                            <i data-id="<%= user._id %>"
                                                                class="<%= (user.main == false && (user.username !== loggedUser.username) ) ? 'superadmin-delete-btns bi-trash' : '' %> "></i>
                                                        </td>
                                                        <% } %>
                            </tr>
                        <% }) %>

                        </tbody>
                    </table>
                </div>
            </div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" id="modal-close" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="modal-save" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="/jquery.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
                    let roleBtns = document.querySelectorAll('.role-expand');
                                                                                                                    let deleteBtns = document.querySelectorAll('.superadmin-delete-btns');
                                                                                                                    let flagBtns = document.querySelectorAll('.change-flag');
                                                                                                                    let taskCreatorBtns = document.querySelectorAll('.permission-toggle');

                    roleBtns.forEach(role => role.addEventListener('click', changeRole));
                    deleteBtns.forEach(btn => btn.addEventListener('click', deleteUser));
                    flagBtns.forEach(flag => flag.addEventListener('click', changeFlag));
                                                                            taskCreatorBtns.forEach(taskCreator => taskCreator.addEventListener('change', taskCreatorEnable));

                async function changeFlag(e) {
                    e.preventDefault();

                    const userId = e.target.dataset.userId;
                    const newFlag = e.target.dataset.flag;

                    // console.log('Nova boja:', newFlag, 'User ID:', userId);

                    try {
                        const res = await fetch(`/admin/superadmin/${userId}/flag`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ flag: newFlag })
                        })
                            .then(res => {

                                if (!res.ok) throw new Error(`Server returned ${res.status}`);
                                return res.json();
                            }).then(data => {
                                if (data.msg === 'Flag updated successfully') {
                                    // Update zastavice odmah u tabeli
                                    const icon = document.querySelector(`#flagDropdown${userId} i`);
                                    icon.className = 'fa-flag fs-4';
                                    if (newFlag === 'green') icon.classList.add('fa-regular', 'text-success');
                                    if (newFlag === 'orange') icon.classList.add('fa-regular', 'text-warning');
                                    if (newFlag === 'red') icon.classList.add('fa-solid', 'text-danger');
                                } else {
                                    alert('Something went wrong');
                                }
                            }
                            )

                    } catch (err) {
                        console.error(err);
                    }
                }

   function deleteUser(e){
       let modalEl = document.getElementById('exampleModal');
       if (!modalEl || typeof bootstrap === 'undefined') return;
       let modal = new bootstrap.Modal(modalEl);
       let title = document.querySelector('.modal-title');
       let body = document.querySelector('.modal-body');
       let closeBtn = document.getElementById('modal-close');
       let saveBtn = document.getElementById('modal-save');
       closeBtn.innerText = "Odustani";
       saveBtn.innerText = "Potvrdi";
       saveBtn.classList.remove("d-none");
       if (title) title.innerText = 'Potvrda brisanja';
       if (body) body.innerText = "Da li ste sigurni da zelite da obri코ete usera?";
       modal.show();

       let id = e.target.getAttribute('data-id');

       saveBtn.addEventListener('click', () => {
   
       // ili let id = e.target.dataset.id;

       if(!id) return alert('ID not found!');
       
       fetch(`/admin/superadmin/${id}`, {method: 'DELETE'})
           .then(res => { 
           if(!res.ok) throw new Error(`Server returned ${res.status}`);
            return res.json();
           })
           .then(data => {
               if(data.msg === 'User deleted successfully'){
                   location.reload();
               }else {
                alert('Something went wrong');
               }
           })
            .catch(err => console.error(err));
        });
       modal.hide();
   }
            function changeRole(e) {
                const cell = e.target;
                e.stopPropagation();     //**********
                if (!cell.classList.contains('clickable')) return;

                // Ako ve캖 postoji select, ne pravimo novi
                // if (cell.querySelector('select')) return;                   //***********

                const userId = cell.dataset.userId;
                const currentRole = cell.dataset.role;

                roleBtns.forEach(c => {                             //*******
                    if (c !== cell) {
                        c.classList.remove('active');
                        const sel = c.querySelector('select');
                        if (sel) {
                            c.innerHTML = sel.value; // vra캖a trenutnu vrednost
                        }
                    }
                });

                // Ako dropdown ve캖 postoji za ovaj cell, samo fokusiraj
                let existingSelect = cell.querySelector('select');
                if (existingSelect) {
                    existingSelect.focus();
                    return;
                }

                // select za main superadmin-a
                const select = document.createElement('select');
                select.className = 'form-select';

                select.innerHTML = `<option value="user">User</option>
                                    <option value="admin">Admin</option>
                                    <option value="superadmin">Superadmin</option>
                                `;

                select.value = currentRole;

                cell.innerHTML = '';
                cell.appendChild(select);
                select.focus();

                // kada promeni코 vrednost
                select.addEventListener('change', async function () {
                    const newRole = this.value;

                    const res = await fetch(`/admin/superadmin/${userId}/role`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: newRole })
                    })
                        .then(res => {
                            if (!res.ok) throw new Error(`Gre코ka pri promeni role`);
                            return res.json();
                        })
                        .then(data => {

                            data.role = newRole;
                            cell.innerHTML = newRole;
                        });
                });
                document.addEventListener('click', () => {
                    roleBtns.forEach(cell => {
                        const select = cell.querySelector('select');
                        if (select) {
                            cell.innerHTML = select.value; // update sa trenutnom vredno코캖u
                        }
                        cell.classList.remove('active');
                    });
                });
                            }
                        
                        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                            return new bootstrap.Tooltip(tooltipTriggerEl)
                        });
                            async function taskCreatorEnable(e) {


                                const userId = e.target.getAttribute('data-user-id');
                                const value = e.target.checked;

                                fetch('/admin/superadmin/update-permission/' + userId, {
                                    method: 'PATCH',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        createTask: value
                                    })
                                }).then(res => {

                                    if (!res.ok) throw new Error(`Server returned ${res.status}`);
                                    return res.json();
                                })
                                    .then(data => {

                                        console.log(user.name, 'je azuriran');

                                        if (!data.success) {
                                            alert('Gre코ka pri a쬿riranju');
                                        }
                                    })
                                                                                    }

                                                                                

</script>
</body>
</html>
